<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - AQI Updates</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .address-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    .divider { border-top: 2px dashed #999; margin: 20px 0; }
    .aqi { font-weight: bold; }
    .wind { font-weight: bold; }
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px;
    }
    .close-modal { float: right; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Your AQI Dashboard</h2>
  <div id="reportContainer">
    <!-- Report data will be inserted here -->
  </div>

  <!-- Modal for choosing fire boundary distance -->
  <div id="fireModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close-modal">&times;</span>
      <h3>Select Distance</h3>
      <p>Choose default distance for fire boundaries/smoke plumes:</p>
      <button class="distanceOption" data-distance="5">5 miles</button>
      <button class="distanceOption" data-distance="10">10 miles</button>
      <button class="distanceOption" data-distance="25">25 miles</button>
      <button class="distanceOption" data-distance="100">100 miles</button>
    </div>
  </div>

  <script>
    // Helper: convert degrees to cardinal direction
    function degreesToCardinal(deg) {
      const directions = ["North", "North-East", "East", "South-East", "South", "South-West", "West", "North-West"];
      deg = deg % 360;
      const index = Math.round(deg / 45) % 8;
      return directions[index];
    }

    // Helper: determine AQI color (based on AirNow guidelines)
    function aqiColor(aqi) {
      if (aqi <= 50) return "green";
      if (aqi <= 100) return "yellow";
      if (aqi <= 150) return "orange";
      if (aqi <= 200) return "red";
      if (aqi <= 300) return "purple";
      return "maroon";
    }

    // Fetch the stored report from the server
    fetch('/api/myReport')
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById('reportContainer');
        if (!data.addresses || data.addresses.length === 0) {
          container.innerHTML = "<p>No report data available. Please try again later.</p>";
          return;
        }
        data.addresses.forEach(addr => {
          const section = document.createElement('div');
          section.className = "address-section";

          // Address header
          const header = document.createElement('h3');
          header.textContent = addr.address;
          section.appendChild(header);

          // Hourly Data
          const hourlyDiv = document.createElement('div');
          const hourlyHeader = document.createElement('h4');
          hourlyHeader.textContent = "Last Hour Data";
          hourlyDiv.appendChild(hourlyHeader);
          const hourlyList = document.createElement('ul');

          // Loop through each AQI source for hourly data
          ["AirNow", "Clarity", "PurpleAir", "SouthCoastAQMD"].forEach(source => {
            if (addr.hourly && addr.hourly[source]) {
              const li = document.createElement('li');
              li.innerHTML = `<span>${source} AQI: </span>` +
                `<span class="aqi" style="color: ${aqiColor(addr.hourly[source].aqi)};">${addr.hourly[source].aqi}</span>`;
              hourlyList.appendChild(li);
            }
          });
          if (addr.hourly && addr.hourly.average !== undefined) {
            const li = document.createElement('li');
            li.innerHTML = `<span>Average AQI: </span>` +
              `<span class="aqi" style="color: ${aqiColor(addr.hourly.average)};">${addr.hourly.average}</span>`;
            hourlyList.appendChild(li);
          }
          if (addr.hourly && addr.hourly.wind) {
            const li = document.createElement('li');
            const wind = addr.hourly.wind;
            li.innerHTML = `<span>Wind: ${wind.speed} mph, Direction: ${wind.deg}° (${degreesToCardinal(wind.deg)})</span>`;
            li.querySelector('span').style.color = wind.color;
            li.title = wind.tooltip;
            hourlyList.appendChild(li);
          }
          if (addr.hourly && addr.hourly.alerts && addr.hourly.alerts.length > 0) {
            const li = document.createElement('li');
            li.innerHTML = "<strong>Recent Alerts:</strong><br/>";
            addr.hourly.alerts.forEach(alert => {
              li.innerHTML += `<a href="${alert.link}" target="_blank">${alert.title}</a><br/>`;
            });
            hourlyList.appendChild(li);
          }
          if (addr.hourly && addr.hourly.fire && addr.hourly.fire.info) {
            const li = document.createElement('li');
            li.innerHTML = `<span>Fire/Soot Info (within <a href="#" class="fire-distance" data-default="${addr.hourly.fire.defaultDistance}">${addr.hourly.fire.defaultDistance} miles</a>): </span>` +
              `<span>${addr.hourly.fire.info}</span>`;
            hourlyList.appendChild(li);
          }
          // Lead, Chlorine, Bromine readings
          ["lead", "chlorine", "bromine"].forEach(elem => {
            if (addr.hourly && addr.hourly[elem] !== undefined) {
              const li = document.createElement('li');
              li.innerHTML = `<span>${elem.charAt(0).toUpperCase() + elem.slice(1)}: ${addr.hourly[elem]}</span>`;
              hourlyList.appendChild(li);
            }
          });
          hourlyDiv.appendChild(hourlyList);
          section.appendChild(hourlyDiv);

          // Divider
          const divider = document.createElement('div');
          divider.className = "divider";
          section.appendChild(divider);

          // 24 Hour Data
          const dailyDiv = document.createElement('div');
          const dailyHeader = document.createElement('h4');
          dailyHeader.textContent = "Last 24 Hour Data";
          dailyDiv.appendChild(dailyHeader);
          const dailyList = document.createElement('ul');
          ["AirNow", "Clarity", "PurpleAir", "SouthCoastAQMD"].forEach(source => {
            if (addr.daily && addr.daily[source]) {
              const li = document.createElement('li');
              li.innerHTML = `<span>${source} AQI: </span>` +
                `<span class="aqi" style="color: ${aqiColor(addr.daily[source].aqi)};">${addr.daily[source].aqi}</span>`;
              dailyList.appendChild(li);
            }
          });
          if (addr.daily && addr.daily.average !== undefined) {
            const li = document.createElement('li');
            li.innerHTML = `<span>Average AQI: </span>` +
              `<span class="aqi" style="color: ${aqiColor(addr.daily.average)};">${addr.daily.average}</span>`;
            dailyList.appendChild(li);
          }
          if (addr.daily && addr.daily.wind) {
            const li = document.createElement('li');
            const wind = addr.daily.wind;
            li.innerHTML = `<span>Wind: ${wind.speed} mph, Direction: ${wind.deg}° (${degreesToCardinal(wind.deg)})</span>`;
            li.querySelector('span').style.color = wind.color;
            li.title = wind.tooltip;
            dailyList.appendChild(li);
          }
          dailyDiv.appendChild(dailyList);
          section.appendChild(dailyDiv);

          container.appendChild(section);
        });
      })
      .catch(err => {
        console.error("Error fetching report:", err);
        document.getElementById('reportContainer').innerHTML = "<p>Error loading report.</p>";
      });

    // Modal logic for fire distance selection
    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('fire-distance')) {
        e.preventDefault();
        document.getElementById('fireModal').style.display = 'block';
      }
    });
    document.getElementById('closeModal').addEventListener('click', function() {
      document.getElementById('fireModal').style.display = 'none';
    });
    document.querySelectorAll('.distanceOption').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const newDistance = btn.getAttribute('data-distance');
        alert("New default distance set to " + newDistance + " miles (update on the server as needed).");
        document.getElementById('fireModal').style.display = 'none';
      });
    });
  </script>
</body>
</html>
